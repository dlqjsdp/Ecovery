<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
  <meta charset="UTF-8">
  <title>회원가입</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label {
      display: inline-block;
      width: 80px;
      margin-bottom: 10px;
    }
    input[type="email"],
    input[type="password"],
    input[type="text"] {
      width: 200px;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }

    /* ✨ 핵심 수정: 에러/성공 메시지가 제대로 보이도록 display와 margin-bottom 추가 */
    .error-message {
      color: red;
      margin-top: 5px;
      font-size: 0.9em;
      display: block;
      margin-bottom: 10px;
    }
    .success-message {
      color: green;
      margin-top: 5px;
      font-size: 0.9em;
      display: block;
      margin-bottom: 10px;
    }
    .email-check-area {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .email-check-area input {
      margin-right: 10px;
    }
  </style>
</head>
<body>
<h2>회원가입</h2>

<form th:action="@{/member/signup}" th:object="${member}" method="post">
  <div class="email-check-area">
    <label for="signupEmail">이메일</label>
    <input type="email" th:field="*{email}" id="signupEmail">
    <button type="button" id="checkEmailBtn">중복 검증</button>
  </div>
  <div id="emailCheckResult" class="error-message"></div>
  <div class="error-message" th:if="${emailError}" th:text="${emailError}"></div>
  <br>

  <label for="signupPassword">비밀번호</label>
  <input type="password" th:field="*{password}" id="signupPassword">
  <div class="error-message" th:if="${passwordError != null}" th:text="${passwordError}"></div><br>
  <h6>비밀번호는 영문자/숫자를 포함하여 8~16자까지 가능하며, 특수문자(!@#$%^&*)만 허용됩니다.</h6>
  <br>

  <div class="nickname-check-area">
    <label for="signupNickname">닉네임</label>
    <input type="text" th:field="*{nickname}" id="signupNickname">
    <button type="button" id="checkNicknameBtn">중복 검증</button>
  </div>
  <div id="nicknameCheckResult" class="error-message"></div>
  <br>

  <button type="submit" id="signupSubmitBtn" disabled>회원가입</button>
</form>

<p><a th:href="@{/member/login}">로그인</a></p>

<script th:inline="javascript">
  /*<![CDATA[*/
  document.addEventListener('DOMContentLoaded', function () {
    const emailInput = document.getElementById('signupEmail');
    const nicknameInput = document.getElementById('signupNickname');
    const passwordInput = document.getElementById('signupPassword');
    const emailBtn = document.getElementById('checkEmailBtn');
    const nicknameBtn = document.getElementById('checkNicknameBtn');
    const submitBtn = document.getElementById('signupSubmitBtn');

    const emailMsg = document.getElementById('emailCheckResult');
    const nicknameMsg = document.getElementById('nicknameCheckResult');

    let isEmailAvailable = false;
    let isNicknameAvailable = false;

    /** 이메일 중복 확인 */
    emailBtn.addEventListener('click', () => {
      const email = emailInput.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      emailMsg.textContent = '';
      emailMsg.className = '';

      if (!email) {
        emailMsg.textContent = '이메일은 필수 입력 항목입니다.';
        emailMsg.className = 'error-message';
        isEmailAvailable = false;
        updateSubmitState();
        return;
      }

      if (!emailRegex.test(email)) {
        emailMsg.textContent = '올바른 이메일 형식이 아닙니다.';
        emailMsg.className = 'error-message';
        isEmailAvailable = false;
        updateSubmitState();
        return;
      }

      fetch('/member/check-email?email=' + encodeURIComponent(email))
              .then(res => res.json())
              .then(data => {
                if (data) {
                  emailMsg.textContent = '이미 사용 중인 이메일입니다.';
                  emailMsg.className = 'error-message';
                  isEmailAvailable = false;
                } else {
                  emailMsg.textContent = '사용 가능한 이메일입니다.';
                  emailMsg.className = 'success-message';
                  isEmailAvailable = true;
                }
                updateSubmitState();
              })
              .catch(() => {
                emailMsg.textContent = '이메일 확인 중 오류 발생';
                emailMsg.className = 'error-message';
                isEmailAvailable = false;
                updateSubmitState();
              });
    });

      /** 닉네임 중복 확인 */
      nicknameBtn.addEventListener('click', () => {
        const nickname = nicknameInput.value.trim();

        nicknameMsg.textContent = '';
        nicknameMsg.className = '';

        if (!nickname) {
          nicknameMsg.textContent = '닉네임은 필수 입력 항목입니다.';
          nicknameMsg.className = 'error-message';
          isNicknameAvailable = false;
          updateSubmitState();
          return;
        }

        fetch('/member/check-nickname?nickname=' + encodeURIComponent(nickname))
                .then(res => res.json())
                .then(data => {
                  if (data) {
                    nicknameMsg.textContent = '이미 사용 중인 닉네임입니다.';
                    nicknameMsg.className = 'error-message';
                    isNicknameAvailable = false;
                  } else {
                    nicknameMsg.textContent = '사용 가능한 닉네임입니다.';
                    nicknameMsg.className = 'success-message';
                    isNicknameAvailable = true;
                  }
                  updateSubmitState();
                })
                .catch(() => {
                  nicknameMsg.textContent = '닉네임 확인 중 오류 발생';
                  nicknameMsg.className = 'error-message';
                  isNicknameAvailable = false;
                  updateSubmitState();
                });
      });

        /** 입력값 변경 시 상태 초기화 */
        emailInput.addEventListener('input', () => {
          emailMsg.textContent = '';
          emailMsg.className = '';
          isEmailAvailable = false;
          updateSubmitState();
        });

        nicknameInput.addEventListener('input', () => {
          nicknameMsg.textContent = '';
          nicknameMsg.className = '';
          isNicknameAvailable = false;
          updateSubmitState();
        });

        passwordInput.addEventListener('input', updateSubmitState);

    /** 버튼 상태 갱신 */
    function updateSubmitState() {
      const isPasswordFilled = passwordInput.value.trim() !== '';
      submitBtn.disabled = !(isEmailAvailable && isNicknameAvailable && isPasswordFilled);
    }
  });
  /*]]>*/
</script>
</body>
</html>